<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiteout Survival - Bear Hunt Formation Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.7)), url('playstore_evening.webp') center/cover fixed no-repeat;
            min-height: 100vh;
            padding: 20px;
            color: #e9ecef;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.55);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1f2a44 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 2rem;
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .input-group {
            background: rgba(255, 255, 255, 0.06);
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .input-group h3 {
            color: #e9ecef;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .form-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
        }

        .form-row label {
            font-weight: 600;
            color: #e9ecef;
            flex: 1;
        }

        .form-row input, .form-row select {
            width: 120px;
            padding: 0.5rem;
            border: 2px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #e9ecef;
            border-radius: 5px;
            text-align: center;
            font-size: 1rem;
        }

        .form-row input:focus, .form-row select:focus {
            outline: none;
            border-color: #8aa2ff;
            box-shadow: 0 0 0 3px rgba(138, 162, 255, 0.25);
        }

        .troop-type {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .troop-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.8rem;
        }

        .infantry { background: #28a745; }
        .lancer { background: #ffc107; color: #333; }
        .marksman { background: #dc3545; }

        .calculate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-bottom: 2rem;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .results-section {
            display: none;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        .results-section.show {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.06);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        .result-card h3 {
            color: #e9ecef;
            margin-bottom: 1rem;
            border-bottom: 2px solid rgba(255,255,255,0.15);
            padding-bottom: 0.5rem;
        }

        .troop-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .troop-result:last-child {
            border-bottom: none;
        }

        .troop-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-section {
            background: rgba(255, 255, 255, 0.06);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .summary-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #8aa2ff;
        }

        .summary-label {
            color: #cfd4da;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .error {
            color: #f8d7da;
            background: rgba(220, 53, 69, 0.15);
            border: 1px solid rgba(220, 53, 69, 0.35);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .success {
            color: #d4edda;
            background: rgba(40, 167, 69, 0.15);
            border: 1px solid rgba(40, 167, 69, 0.35);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .footer {
            text-align: center;
            padding: 2rem;
            border-top: 1px solid #dee2e6;
            margin-top: 2rem;
        }

        .footer a {
            color: #8aa2ff;
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .rally-customization {
            display: none;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .rally-customization.show {
            display: block;
        }

        .disclaimer {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            color: #721c24;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .input-section {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öîÔ∏è Whiteout Survival - Bear Hunt Formation Calculator</h1>
            <p>Advanced Formation Calculator - Optimize Your Troop Deployment</p>
        </div>

        <div class="content">
            <div style="background: rgba(33, 150, 243, 0.12); border-left: 4px solid #2196f3; padding: 1rem; margin-bottom: 2rem; border-radius: 5px;">
                <p style="margin: 0; color: #d0e7ff; font-size: 1rem; line-height: 1.5;">
                    <strong>How it works:</strong> Enter your troop counts and settings below. Set minimum requirements for all marches and rally (recommended: at least some of each troop type for optimal damage). You can customize rally ratios, but only use this if your rally performs really well (rally troops are locked for 5 minutes while squads can be reused 2-3 times, and damage doesn't scale linearly). Click calculate, then set your squads in WOS with the amounts shown. All squads will be identical, so you can assign them to your three bear heroes. If heroes are unavailable, just click the squad to deploy troops without heroes.
                </p>
                <p style="margin: 0.5rem 0 0 0; color: #d0e7ff; font-size: 0.9rem; line-height: 1.4;">
                    <strong>Alternative:</strong> Try the <a href="basic.html" style="color: #0d47a1; text-decoration: underline;">Basic Version</a> below for a simpler approach that prioritizes filling your rally and as many squads as possible with a good ratio - easier to set up but less optimal.
                </p>
            </div>
            
            <div class="input-section">
                <div class="input-group">
                    <h3>üéØ Troop Counts</h3>
                                         <div class="form-row">
                         <div class="troop-type">
                             <div class="troop-icon infantry">I</div>
                             <label>Infantry:</label>
                         </div>
                         <input type="number" id="infantry" min="0" value="200000">
                     </div>
                     <div class="form-row">
                         <div class="troop-type">
                             <div class="troop-icon lancer">L</div>
                             <label>Lancers:</label>
                         </div>
                         <input type="number" id="lancers" min="0" value="200000">
                     </div>
                     <div class="form-row">
                         <div class="troop-type">
                             <div class="troop-icon marksman">M</div>
                             <label>Marksmen:</label>
                         </div>
                         <input type="number" id="marksmen" min="0" value="200000">
                     </div>
                </div>

                <div class="input-group">
                    <h3>‚ö° Deployment Settings</h3>
                                         <div class="form-row">
                         <label>Number of Marches:</label>
                         <input type="number" id="marches" min="3" max="6" value="6">
                     </div>
                     <div class="form-row">
                         <label>Deployment Limit per March:</label>
                         <input type="number" id="marchLimit" min="1000" value="60000">
                     </div>
                     <div class="form-row">
                         <label>March Deployment Capacity:</label>
                         <input type="number" id="rallyCapacity" min="1000" value="120000">
                     </div>
                    <div class="form-row">
                        <label>Customize Rally:</label>
                        <select id="rallyCustomization" style="width: 120px; padding: 0.5rem; border: 2px solid #dee2e6; border-radius: 5px; font-size: 1rem;">
                            <option value="no">No</option>
                            <option value="yes">Yes</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <h3>üìä Squad Minimum Requirements</h3>
                    <div class="form-row">
                        <label>Min Infantry per Squad:</label>
                        <input type="number" id="minSquadInfantry" min="0" value="5000">
                    </div>
                    <div class="form-row">
                        <label>Min Lancers per Squad:</label>
                        <input type="number" id="minSquadLancers" min="0" value="10000">
                    </div>
                    <div class="form-row">
                        <label>Min Marksmen per Squad:</label>
                        <input type="number" id="minSquadMarksmen" min="0" value="10000">
                    </div>
                </div>
                
                <div class="input-group">
                    <h3>üéØ Rally Minimum Requirements</h3>
                    <div class="form-row">
                        <label>Min Infantry for Rally:</label>
                        <input type="number" id="minRallyInfantry" min="0" value="5000">
                    </div>
                    <div class="form-row">
                        <label>Min Lancers for Rally:</label>
                        <input type="number" id="minRallyLancers" min="0" value="10000">
                    </div>
                    <div class="form-row">
                        <label>Min Marksmen for Rally:</label>
                        <input type="number" id="minRallyMarksmen" min="0" value="10000">
                    </div>
                </div>
            </div>

            <div id="rally-customization" class="rally-customization">
                <div class="disclaimer">
                    <strong>‚ö†Ô∏è Disclaimer:</strong> Only use this if your rally is performing well. Otherwise, leave it disabled.
                </div>
                <h3>üéØ Rally Troop Ratio</h3>
                <div class="form-row">
                    <label>Infantry %:</label>
                    <input type="number" id="rallyInfantryRatio" min="0" max="100" value="10">
                </div>
                <div class="form-row">
                    <label>Lancers %:</label>
                    <input type="number" id="rallyLancerRatio" min="0" max="100" value="40">
                </div>
                <div class="form-row">
                    <label>Marksmen %:</label>
                    <input type="number" id="rallyMarksmanRatio" min="0" max="100" value="50">
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateFormation()">
                üßÆ Calculate Optimal Formation
            </button>

            <div id="error-message" class="error" style="display: none;"></div>
            <div id="success-message" class="success" style="display: none;"></div>

            <div id="results" class="results-section">
                <div class="results-grid">
                    <div class="result-card">
                        <h3>üéñÔ∏è Squad Formation (Per Squad)</h3>
                        <div id="squad-results"></div>
                    </div>
                    <div class="result-card">
                        <h3>üöÄ Rally Formation</h3>
                        <div id="rally-results"></div>
                    </div>
                </div>

                <div class="summary-section">
                    <h3>üìà Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-value" id="total-used">0</div>
                            <div class="summary-label">Total Troops Used</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="total-leftover">0</div>
                            <div class="summary-label">Total Leftover</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="squad-total">0</div>
                            <div class="summary-label">Squad Total</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="rally-total">0</div>
                            <div class="summary-label">Rally Total</div>
                        </div>
                    </div>
                    
                    <div id="leftover-breakdown" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #dee2e6;">
                        <h4 style="color: #495057; margin-bottom: 1rem;">üì¶ Leftover Troops Breakdown</h4>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-value" id="leftover-infantry">0</div>
                                <div class="summary-label">Leftover Infantry</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="leftover-lancers">0</div>
                                <div class="summary-label">Leftover Lancers</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="leftover-marksmen">0</div>
                                <div class="summary-label">Leftover Marksmen</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <a href="basic.html">Basic Version</a> | 
            <a href="hero-gear-guide.html">Hero Gear Guide</a>
        </div>
    </div>

    <script>
        // Show/hide rally customization based on selection
        document.getElementById('rallyCustomization').addEventListener('change', function() {
            const customizationDiv = document.getElementById('rally-customization');
            if (this.value === 'yes') {
                customizationDiv.classList.add('show');
            } else {
                customizationDiv.classList.remove('show');
            }
        });

        function calculateFormation() {
            // Clear previous messages
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';

            // Get input values
            const infantry = parseInt(document.getElementById('infantry').value) || 0;
            const lancers = parseInt(document.getElementById('lancers').value) || 0;
            const marksmen = parseInt(document.getElementById('marksmen').value) || 0;
            const marches = parseInt(document.getElementById('marches').value) || 5;
            const marchLimit = parseInt(document.getElementById('marchLimit').value) || 60000;
            const rallyCapacity = parseInt(document.getElementById('rallyCapacity').value) || 100000;
            const minSquadInfantry = parseInt(document.getElementById('minSquadInfantry').value) || 0;
            const minSquadLancers = parseInt(document.getElementById('minSquadLancers').value) || 0;
            const minSquadMarksmen = parseInt(document.getElementById('minSquadMarksmen').value) || 0;
            const minRallyInfantry = parseInt(document.getElementById('minRallyInfantry').value) || 0;
            const minRallyLancers = parseInt(document.getElementById('minRallyLancers').value) || 0;
            const minRallyMarksmen = parseInt(document.getElementById('minRallyMarksmen').value) || 0;
            const rallyCustomization = document.getElementById('rallyCustomization').value;
            const rallyInfantryRatio = parseInt(document.getElementById('rallyInfantryRatio').value) || 10;
            const rallyLancerRatio = parseInt(document.getElementById('rallyLancerRatio').value) || 40;
            const rallyMarksmanRatio = parseInt(document.getElementById('rallyMarksmanRatio').value) || 50;

            // Validate inputs
            if (marches < 3 || marches > 6) {
                showError('Number of marches must be between 3 and 6');
                return;
            }

            if (infantry < 0 || lancers < 0 || marksmen < 0) {
                showError('Troop counts cannot be negative');
                return;
            }

            if (rallyCustomization === 'yes') {
                const totalRatio = rallyInfantryRatio + rallyLancerRatio + rallyMarksmanRatio;
                if (totalRatio !== 100) {
                    showError('Rally ratios must add up to 100% (currently ' + totalRatio + '%)');
                    return;
                }
            }

            // Calculate formation
            const result = allocateTroops({
                infantry, lancers, marksmen, marches, marchLimit, rallyCapacity,
                minSquadInfantry, minSquadLancers, minSquadMarksmen,
                minRallyInfantry, minRallyLancers, minRallyMarksmen,
                rallyCustomization, rallyInfantryRatio, rallyLancerRatio, rallyMarksmanRatio
            });

            if (result.error) {
                showError(result.error);
                return;
            }

            // Display results
            displayResults(result);
            showSuccess('Formation calculated successfully!');
        }

        function allocateTroops(params) {
            const {
                infantry, lancers, marksmen, marches, marchLimit, rallyCapacity,
                minSquadInfantry, minSquadLancers, minSquadMarksmen,
                minRallyInfantry, minRallyLancers, minRallyMarksmen,
                rallyCustomization, rallyInfantryRatio, rallyLancerRatio, rallyMarksmanRatio
            } = params;

            // Calculate total minimum requirements
            const totalMinInfantry = (minSquadInfantry * marches) + minRallyInfantry;
            const totalMinLancers = (minSquadLancers * marches) + minRallyLancers;
            const totalMinMarksmen = (minSquadMarksmen * marches) + minRallyMarksmen;

            // Check if we have enough troops for minimums
            if (infantry < totalMinInfantry) {
                return { error: `Not enough Infantry. Need ${totalMinInfantry.toLocaleString()}, have ${infantry.toLocaleString()}` };
            }
            if (lancers < totalMinLancers) {
                return { error: `Not enough Lancers. Need ${totalMinLancers.toLocaleString()}, have ${lancers.toLocaleString()}` };
            }
            if (marksmen < totalMinMarksmen) {
                return { error: `Not enough Marksmen. Need ${totalMinMarksmen.toLocaleString()}, have ${marksmen.toLocaleString()}` };
            }

            // Initialize allocation
            const squad = {
                infantry: minSquadInfantry * marches,
                lancers: minSquadLancers * marches,
                marksmen: minSquadMarksmen * marches
            };

            const rally = {
                infantry: minRallyInfantry,
                lancers: minRallyLancers,
                marksmen: minRallyMarksmen
            };

            // Calculate remaining troops after minimum allocation
            let remainingInfantry = infantry - totalMinInfantry;
            let remainingLancers = lancers - totalMinLancers;
            let remainingMarksmen = marksmen - totalMinMarksmen;

            if (rallyCustomization === 'yes') {
                // CUSTOM RALLY: Fill rally first with custom ratio
                const rallySpace = rallyCapacity - (rally.infantry + rally.lancers + rally.marksmen);
                
                if (rallySpace > 0) {
                    // Calculate target rally composition with custom ratios
                    const targetRallyInfantry = Math.floor(rallyCapacity * (rallyInfantryRatio / 100));
                    const targetRallyLancers = Math.floor(rallyCapacity * (rallyLancerRatio / 100));
                    const targetRallyMarksmen = Math.floor(rallyCapacity * (rallyMarksmanRatio / 100));
                    
                    // Fill rally with Marksmen first (highest priority)
                    const rallyMarksmenNeeded = Math.max(0, targetRallyMarksmen - rally.marksmen);
                    const rallyMarksmenToAdd = Math.min(remainingMarksmen, rallyMarksmenNeeded, rallySpace);
                    if (rallyMarksmenToAdd > 0) {
                        rally.marksmen += rallyMarksmenToAdd;
                        remainingMarksmen -= rallyMarksmenToAdd;
                    }
                    
                    // Fill rally with Lancers
                    const remainingRallySpace = rallyCapacity - (rally.infantry + rally.lancers + rally.marksmen);
                    const rallyLancersNeeded = Math.max(0, targetRallyLancers - rally.lancers);
                    const rallyLancersToAdd = Math.min(remainingLancers, rallyLancersNeeded, remainingRallySpace);
                    if (rallyLancersToAdd > 0) {
                        rally.lancers += rallyLancersToAdd;
                        remainingLancers -= rallyLancersToAdd;
                    }
                    
                    // Fill rally with Infantry
                    const finalRallySpace = rallyCapacity - (rally.infantry + rally.lancers + rally.marksmen);
                    const rallyInfantryNeeded = Math.max(0, targetRallyInfantry - rally.infantry);
                    const rallyInfantryToAdd = Math.min(remainingInfantry, rallyInfantryNeeded, finalRallySpace);
                    if (rallyInfantryToAdd > 0) {
                        rally.infantry += rallyInfantryToAdd;
                        remainingInfantry -= rallyInfantryToAdd;
                    }
                }
                
                // Now fill squads with remaining troops (Marksmen first, then Lancers, then Infantry)
                const squadSpace = (marchLimit * marches) - (squad.infantry + squad.lancers + squad.marksmen);
                
                // Fill squads with Marksmen
                let squadMarksmenToAdd = Math.min(remainingMarksmen, squadSpace);
                if (squadMarksmenToAdd > 0) {
                    const marksmenPerMarch = Math.floor(squadMarksmenToAdd / marches);
                    const extraMarksmen = squadMarksmenToAdd % marches;
                    
                    squad.marksmen += marksmenPerMarch * marches;
                    // Distribute extra marksmen to first few marches
                    for (let i = 0; i < extraMarksmen; i++) {
                        squad.marksmen += 1;
                    }
                    remainingMarksmen -= squadMarksmenToAdd;
                }
                
                // Fill squads with Lancers
                const remainingSquadSpace = (marchLimit * marches) - (squad.infantry + squad.lancers + squad.marksmen);
                let squadLancersToAdd = Math.min(remainingLancers, remainingSquadSpace);
                if (squadLancersToAdd > 0) {
                    const lancersPerMarch = Math.floor(squadLancersToAdd / marches);
                    const extraLancers = squadLancersToAdd % marches;
                    
                    squad.lancers += lancersPerMarch * marches;
                    // Distribute extra lancers to first few marches
                    for (let i = 0; i < extraLancers; i++) {
                        squad.lancers += 1;
                    }
                    remainingLancers -= squadLancersToAdd;
                }
                
                // Fill squads with Infantry
                const finalSquadSpace = (marchLimit * marches) - (squad.infantry + squad.lancers + squad.marksmen);
                let squadInfantryToAdd = Math.min(remainingInfantry, finalSquadSpace);
                if (squadInfantryToAdd > 0) {
                    const infantryPerMarch = Math.floor(squadInfantryToAdd / marches);
                    const extraInfantry = squadInfantryToAdd % marches;
                    
                    squad.infantry += infantryPerMarch * marches;
                    // Distribute extra infantry to first few marches
                    for (let i = 0; i < extraInfantry; i++) {
                        squad.infantry += 1;
                    }
                    remainingInfantry -= squadInfantryToAdd;
                }
                
            } else {
                // NO CUSTOM RALLY: Original algorithm - fill squads first, then rally
                const squadSpace = (marchLimit * marches) - (squad.infantry + squad.lancers + squad.marksmen);
                const rallySpace = rallyCapacity - (rally.infantry + rally.lancers + rally.marksmen);

                // Fill squads with Marksmen first (highest priority)
                let squadMarksmenToAdd = Math.min(remainingMarksmen, squadSpace);
                if (squadMarksmenToAdd > 0) {
                    const marksmenPerMarch = Math.floor(squadMarksmenToAdd / marches);
                    const extraMarksmen = squadMarksmenToAdd % marches;
                    
                    squad.marksmen += marksmenPerMarch * marches;
                    // Distribute extra marksmen to first few marches
                    for (let i = 0; i < extraMarksmen; i++) {
                        squad.marksmen += 1;
                    }
                    remainingMarksmen -= squadMarksmenToAdd;
                }

                // Fill squads with Lancers
                const remainingSquadSpace = (marchLimit * marches) - (squad.infantry + squad.lancers + squad.marksmen);
                let squadLancersToAdd = Math.min(remainingLancers, remainingSquadSpace);
                if (squadLancersToAdd > 0) {
                    const lancersPerMarch = Math.floor(squadLancersToAdd / marches);
                    const extraLancers = squadLancersToAdd % marches;
                    
                    squad.lancers += lancersPerMarch * marches;
                    // Distribute extra lancers to first few marches
                    for (let i = 0; i < extraLancers; i++) {
                        squad.lancers += 1;
                    }
                    remainingLancers -= squadLancersToAdd;
                }

                // Fill squads with Infantry
                const finalSquadSpace = (marchLimit * marches) - (squad.infantry + squad.lancers + squad.marksmen);
                let squadInfantryToAdd = Math.min(remainingInfantry, finalSquadSpace);
                if (squadInfantryToAdd > 0) {
                    const infantryPerMarch = Math.floor(squadInfantryToAdd / marches);
                    const extraInfantry = squadInfantryToAdd % marches;
                    
                    squad.infantry += infantryPerMarch * marches;
                    // Distribute extra infantry to first few marches
                    for (let i = 0; i < extraInfantry; i++) {
                        squad.infantry += 1;
                    }
                    remainingInfantry -= squadInfantryToAdd;
                }

                // Now fill rally with remaining troops (Marksmen first, then Lancers, then Infantry)
                let rallyMarksmenToAdd = Math.min(remainingMarksmen, rallySpace);
                if (rallyMarksmenToAdd > 0) {
                    rally.marksmen += rallyMarksmenToAdd;
                    remainingMarksmen -= rallyMarksmenToAdd;
                }

                const remainingRallySpace = rallyCapacity - (rally.infantry + rally.lancers + rally.marksmen);
                let rallyLancersToAdd = Math.min(remainingLancers, remainingRallySpace);
                if (rallyLancersToAdd > 0) {
                    rally.lancers += rallyLancersToAdd;
                    remainingLancers -= rallyLancersToAdd;
                }

                const finalRallySpace = rallyCapacity - (rally.infantry + rally.lancers + rally.marksmen);
                let rallyInfantryToAdd = Math.min(remainingInfantry, finalRallySpace);
                if (rallyInfantryToAdd > 0) {
                    rally.infantry += rallyInfantryToAdd;
                    remainingInfantry -= rallyInfantryToAdd;
                }
            }

            return {
                squad,
                rally,
                leftover: {
                    infantry: remainingInfantry,
                    lancers: remainingLancers,
                    marksmen: remainingMarksmen
                },
                totalUsed: {
                    infantry: infantry - remainingInfantry,
                    lancers: lancers - remainingLancers,
                    marksmen: marksmen - remainingMarksmen
                }
            };
        }

        function displayResults(result) {
            const marches = parseInt(document.getElementById('marches').value) || 5;
            const marchLimit = parseInt(document.getElementById('marchLimit').value) || 60000;
            const rallyCapacity = parseInt(document.getElementById('rallyCapacity').value) || 100000;

            // Calculate per-march breakdown
            const infantryPerMarch = Math.floor(result.squad.infantry / marches);
            const lancersPerMarch = Math.floor(result.squad.lancers / marches);
            const marksmenPerMarch = Math.floor(result.squad.marksmen / marches);

            // Display squad results (per squad since they're all the same)
            const squadResults = document.getElementById('squad-results');
            squadResults.innerHTML = `
                <div class="troop-result">
                    <div class="troop-name">
                        <div class="troop-icon infantry">I</div>
                        <span>Infantry per squad</span>
                    </div>
                    <span>${infantryPerMarch.toLocaleString()}</span>
                </div>
                <div class="troop-result">
                    <div class="troop-name">
                        <div class="troop-icon lancer">L</div>
                        <span>Lancers per squad</span>
                    </div>
                    <span>${lancersPerMarch.toLocaleString()}</span>
                </div>
                <div class="troop-result">
                    <div class="troop-name">
                        <div class="troop-icon marksman">M</div>
                        <span>Marksmen per squad</span>
                    </div>
                    <span>${marksmenPerMarch.toLocaleString()}</span>
                </div>
                <div class="troop-result" style="border-top: 2px solid #dee2e6; margin-top: 0.5rem; padding-top: 0.5rem;">
                    <div class="troop-name">
                        <span><strong>Total per squad</strong></span>
                    </div>
                    <span><strong>${Math.floor((result.squad.infantry + result.squad.lancers + result.squad.marksmen) / marches).toLocaleString()}</strong></span>
                </div>
                <div class="troop-result" style="font-size: 0.9rem; color: #666;">
                    <div class="troop-name">
                        <span>Squad limit</span>
                    </div>
                    <span>${marchLimit.toLocaleString()}</span>
                </div>
            `;

            // Display rally results
            const rallyResults = document.getElementById('rally-results');
            rallyResults.innerHTML = `
                <div class="troop-result">
                    <div class="troop-name">
                        <div class="troop-icon infantry">I</div>
                        <span>Infantry</span>
                    </div>
                    <span>${result.rally.infantry.toLocaleString()}</span>
                </div>
                <div class="troop-result">
                    <div class="troop-name">
                        <div class="troop-icon lancer">L</div>
                        <span>Lancers</span>
                    </div>
                    <span>${result.rally.lancers.toLocaleString()}</span>
                </div>
                <div class="troop-result">
                    <div class="troop-name">
                        <div class="troop-icon marksman">M</div>
                        <span>Marksmen</span>
                    </div>
                    <span>${result.rally.marksmen.toLocaleString()}</span>
                </div>
                <div class="troop-result" style="border-top: 2px solid #dee2e6; margin-top: 0.5rem; padding-top: 0.5rem;">
                    <div class="troop-name">
                        <span><strong>Total Rally Troops</strong></span>
                    </div>
                    <span><strong>${(result.rally.infantry + result.rally.lancers + result.rally.marksmen).toLocaleString()}</strong></span>
                </div>
                <div class="troop-result" style="font-size: 0.9rem; color: #666;">
                    <div class="troop-name">
                        <span>Rally capacity</span>
                    </div>
                    <span>${rallyCapacity.toLocaleString()}</span>
                </div>
            `;

            // Update summary
            const totalUsed = result.totalUsed.infantry + result.totalUsed.lancers + result.totalUsed.marksmen;
            const totalLeftover = result.leftover.infantry + result.leftover.lancers + result.leftover.marksmen;
            const squadTotal = result.squad.infantry + result.squad.lancers + result.squad.marksmen;
            const rallyTotal = result.rally.infantry + result.rally.lancers + result.rally.marksmen;

            document.getElementById('total-used').textContent = totalUsed.toLocaleString();
            document.getElementById('total-leftover').textContent = totalLeftover.toLocaleString();
            document.getElementById('squad-total').textContent = squadTotal.toLocaleString();
            document.getElementById('rally-total').textContent = rallyTotal.toLocaleString();

            // Update leftover breakdown
            document.getElementById('leftover-infantry').textContent = result.leftover.infantry.toLocaleString();
            document.getElementById('leftover-lancers').textContent = result.leftover.lancers.toLocaleString();
            document.getElementById('leftover-marksmen').textContent = result.leftover.marksmen.toLocaleString();

            // Show results
            document.getElementById('results').classList.add('show');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('results').classList.remove('show');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }

        // Add input validation
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', function() {
                if (this.value < 0) this.value = 0;
            });
        });
    </script>
</body>
</html> 